name: Migration Orchestrator (Repository Dispatch)

on:
  workflow_call:
    inputs:
      TARGET_ORGANIZATION:
        description: 'The GitHub Enterprise Cloud organization to migrate to'
        required: true
        type: string
      RUNNER:
        description: 'The runner to use for all of the jobs in the workflow'
        type: string
        default: 'ubuntu-latest'
      INSTALL_PREREQS:
        description: 'If set to true, installs pre-requisites from apt, pwsh, and gei'
        type: string
        default: 'true'
      BATCH_SIZE:
        description: 'Number of repositories per batch'
        type: number
        default: 250
      MIGRATION_TYPE:
        description: 'Type of migration (dry-run or production)'
        required: true
        type: string
    secrets:
      TARGET_ADMIN_TOKEN:
        required: true
      SOURCE_ADMIN_TOKEN:
        required: true
      AZURE_STORAGE_CONNECTION_STRING:
        required: true
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true

jobs:
  prepare-migration-batches:
    name: Prepare Migration Batches
    runs-on: ${{ inputs.RUNNER }}
    outputs:
      batches: ${{ steps.create-batches.outputs.batches }}
      migration_id: ${{ steps.generate-id.outputs.id }}
      batch_count: ${{ steps.create-batches.outputs.batch_count }}
      migration_type: ${{ steps.determine-type.outputs.type }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Extract migration parameters from issue
        id: parse-issue-body
        uses: stefanbuck/github-issue-parser@v3
        
      - name: Create unique migration identifier
        id: generate-id
        run: echo "id=${{ github.run_id }}-${{ github.run_attempt }}" >> $GITHUB_OUTPUT
        
      - name: Set migration mode (dry-run/production)
        id: determine-type
        run: |
          echo "type=${{ inputs.MIGRATION_TYPE }}" >> $GITHUB_OUTPUT
        
      - name: Split repositories into batches of ${{ inputs.BATCH_SIZE }}
        id: create-batches
        uses: actions/github-script@v8
        with:
          script: |
            const script = require('./.github/scripts/orchestration/create-batches.js');
            return await script({context, core});
        env:
          REPOS: ${{ inputs.REPOSITORY_URLS }}
          BATCH_SIZE: ${{ inputs.BATCH_SIZE }}
          MIGRATION_ID: ${{ steps.generate-id.outputs.id }}
          MIGRATION_TYPE: ${{ inputs.MIGRATION_TYPE }}
          SOURCE_ORG: ${{ inputs.SOURCE_ORG }}
          TARGET_ORG: ${{ inputs.TARGET_ORG }}
          VISIBILITY: ${{ fromJSON(steps.parse-issue-body.outputs.jsonString)._target_repository_visibility }}
          INSTALL_PREREQS: ${{ inputs.INSTALL_PREREQS }}
            
      - name: Post migration start notification
        uses: actions/github-script@v8
        env:
          MIGRATION_TYPE: ${{ inputs.MIGRATION_TYPE }}
          BATCH_COUNT: ${{ steps.create-batches.outputs.batch_count }}
          BATCH_SIZE: ${{ inputs.BATCH_SIZE }}
          TOTAL_REPOS: ${{ steps.create-batches.outputs.total_repos }}
          TARGET_ORG: ${{ inputs.TARGET_ORGANIZATION }}
        with:
          script: |
            const script = require('./.github/scripts/reporting/start-migration.js');
            return await script({github, context});

  orchestrate-batch-execution:
    name: Orchestrate sequential batch execution
    needs: [prepare-migration-batches]
    if: always() && needs.prepare-migration-batches.result == 'success'
    runs-on: ${{ inputs.RUNNER }}
    timeout-minutes: 50400
    steps:
      - uses: actions/checkout@v4
      - name: Orchestrate sequential batch execution
        uses: actions/github-script@v8
        env:
          BATCHES: ${{ needs.prepare-migration-batches.outputs.batches }}
          TARGET_ADMIN_TOKEN: ${{ secrets.TARGET_ADMIN_TOKEN }}
        with:
          script: |
            const script = require('./.github/scripts/orchestration/orchestrate.js');
            return await script({github, context});

  post-migration-summary:
    name: Post Migration Summary
    needs: [prepare-migration-batches, orchestrate-batch-execution]
    runs-on: ${{ inputs.RUNNER }}
    if: always() && needs.prepare-migration-batches.result == 'success'
    steps:
      - uses: actions/checkout@v4
      
      - name: Generate special features migration report
        uses: actions/github-script@v8
        with:
          script: |
            const script = require('./.github/scripts/reporting/feature-report.js');
            const hasFeatures = await script({github, context, core});
            
            if (!hasFeatures) {
              console.log('No special features (LFS/packages/releases) were migrated');
            } else {
              console.log('Special features report posted to issue');
            }
      
      - name: Post migration completion summary
        uses: actions/github-script@v8
        env:
          BATCH_COUNT: ${{ needs.prepare-migration-batches.outputs.batch_count }}
          MIGRATION_TYPE: ${{ needs.prepare-migration-batches.outputs.migration_type }}
          TARGET_ORG: ${{ inputs.TARGET_ORGANIZATION }}
        with:
          script: |
            const script = require('./.github/scripts/reporting/final-report.js');
            return await script({github, context});