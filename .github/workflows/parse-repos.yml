name: Parse Repository List

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write

jobs:
  acknowledge-repo-list:
    if: |
      contains(github.event.issue.labels.*.name, 'migration') &&
      contains(github.event.issue.labels.*.name, 'batch')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check if Step 3 exists (user should be at this step)
        id: check-step
        uses: actions/github-script@v8
        with:
          script: |
            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            const step3Exists = comments.data.some(c => 
              c.body.includes('Step 3: Provide Repository URLs')
            );
            
            const step4Exists = comments.data.some(c => 
              c.body.includes('Step 4: Ready to Migrate')
            );
            
            core.setOutput('step3_exists', step3Exists.toString());
            core.setOutput('step4_exists', step4Exists.toString());
      
      - name: Parse issue to get visibility
        if: |
          steps.check-step.outputs.step3_exists == 'true' &&
          steps.check-step.outputs.step4_exists == 'false'
        id: parse-issue
        uses: stefanbuck/github-issue-parser@v3
      
      - name: Parse and validate repository list from comment
        if: |
          steps.check-step.outputs.step3_exists == 'true' &&
          steps.check-step.outputs.step4_exists == 'false'
        id: parse-repos
        uses: actions/github-script@v8
        with:
          script: |
            const body = context.payload.comment.body;
            
            // Skip if this is a command or bot comment
            if (body.startsWith('/') || 
                context.payload.comment.user.type === 'Bot') {
              console.log('Skipping command or bot comment');
              return;
            }
            
            // Parse URLs from the comment
            const cleanedText = body
              .replace(/<details[^>]*>/gi, '')
              .replace(/<\/details>/gi, '')
              .replace(/<summary[^>]*>/gi, '')
              .replace(/<\/summary>/gi, '')
              .replace(/<!--[\s\S]*?-->/g, '');
            
            const repoUrls = cleanedText
              .split('\n')
              .map(line => line.trim())
              .filter(line => {
                if (!line) return false;
                if (line.includes('<') && line.includes('>')) return false;
                if (line.startsWith('#') && !line.includes('://')) return false;
                return line.includes('://') || line.includes('github.');
              });
            
            // Need at least one repo URL to proceed
            if (repoUrls.length === 0) {
              console.log('No repository URLs found in comment, skipping');
              return;
            }
            
            console.log(`Found ${repoUrls.length} repository URLs`);
            
            // Set output for next step
            core.setOutput('repo_count', repoUrls.length);
            core.setOutput('repo_urls', JSON.stringify(repoUrls));
            
            // Create repo state object
            const repoState = {
              repositories: repoUrls,
              count: repoUrls.length,
              timestamp: new Date().toISOString()
            };
            
            // Build comment body with properly escaped backticks
            const repoList = repoUrls.map((url, i) => `${i + 1}. \`${url}\``).join('\n');
            const jsonBlock = '```json\n' + JSON.stringify(repoState, null, 2) + '\n```';
            
            const commentBody = `### âœ… Repository List Received

**Count:** ${repoUrls.length} repositories

<details>
<summary>ðŸ“‹ Repositories</summary>

${repoList}

${jsonBlock}

</details>

---

â­ï¸ **Proceeding to Step 4...**`;
            
            // Post confirmation with JSON
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });
      
      - name: Extract selected organizations from JSON state
        if: |
          steps.parse-repos.outputs.repo_count != '' &&
          steps.parse-repos.outputs.repo_count != '0'
        id: extract-orgs
        uses: actions/github-script@v8
        with:
          script: |
            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            // Find the state comment with JSON
            const stateComment = comments.data.find(c => 
              c.body.includes('âœ… Organizations Selected') &&
              c.body.includes('ðŸ“Š Configuration Data')
            );
            
            if (!stateComment) {
              console.log('No org state found, using defaults');
              core.setOutput('source_org', 'source-org');
              core.setOutput('target_org', 'target-org');
              return;
            }
            
            // Extract JSON from comment
            const jsonMatch = stateComment.body.match(/```json\n([\s\S]*?)\n```/);
            
            if (!jsonMatch) {
              console.log('Could not parse JSON from state comment');
              core.setOutput('source_org', 'source-org');
              core.setOutput('target_org', 'target-org');
              return;
            }
            
            const state = JSON.parse(jsonMatch[1]);
            
            console.log(`Extracted from JSON: ${state.sourceOrg} â†’ ${state.targetOrg}`);
            
            core.setOutput('source_org', state.sourceOrg);
            core.setOutput('target_org', state.targetOrg);

      - name: Post Step 4 - Migration Instructions
        if: |
          steps.parse-repos.outputs.repo_count != '' &&
          steps.parse-repos.outputs.repo_count != '0'
        uses: actions/github-script@v8
        env:
          REPO_URLS_JSON: ${{ steps.parse-repos.outputs.repo_urls }}
          VISIBILITY: ${{ fromJSON(steps.parse-issue.outputs.jsonString)._target_repository_visibility }}
          TARGET_ORG: ${{ steps.extract-orgs.outputs.target_org }}
          SOURCE_ORG: ${{ steps.extract-orgs.outputs.source_org }}
        with:
          script: |
            // Check if Step 4 already posted
            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            const step4Exists = comments.data.some(c => 
              c.body.includes('Step 4: Ready to Migrate')
            );
            
            if (step4Exists) {
              console.log('Step 4 already posted, skipping');
              return;
            }
            
            // Convert JSON array back to newline-separated text for init-issue.js
            const repoUrls = JSON.parse(process.env.REPO_URLS_JSON);
            const repoText = repoUrls.join('\n');
            
            // Set REPOSITORIES env var with the text format (for backward compat with init-issue.js)
            process.env.REPOSITORIES = repoText;
            
            console.log(`Passing ${repoUrls.length} repos to init-issue.js`);
            
            // Post Step 4
            const script = require('./.github/scripts/reporting/init-issue.js');
            await script({github, context});